using System;
using System.Threading;
using System.Data.SQLite;
using Cabinink.Writer.UI;
using System.Windows.Forms;
using Cabinink.Writer.Cores;
using Cabinink.Writer.Middle;
using System.Collections.Generic;
namespace Cabinink
{
   /// <summary>
   /// 用于访问应用程序主入口点的静态类
   /// </summary>
   public static class Program
   {
      private const string ABP_BASE = " Base";
      private const string ABP_ALPHA = " Alpha";
      private const string ABP_BETA = "Beta";
      private const string ABP_RC = " RC";
      private const string ABP_RELEASE = " Release";
      public static string AppBuildingProcessFlag = ABP_BASE;
      public static BaiduCloudBackup CloudBackup;
      public static List<Project> Projects = new List<Project>();
      public static List<string> IntelliSenceSources = new List<string>();
      /// <summary>
      /// 应用程序的主入口点
      /// </summary>
      [STAThread]
      public static void Main()
      {
         Application.SetUnhandledExceptionMode(UnhandledExceptionMode.CatchException);
         Application.ThreadException += new ThreadExceptionEventHandler(UIThreadUnhandledExceptionCatched);
         AppDomain.CurrentDomain.UnhandledException += new UnhandledExceptionEventHandler(CoresThreadUnhandledExceptionCatched);
         Application.EnableVisualStyles();
         Application.SetCompatibleTextRenderingDefault(false);
         frmMainInterface main = new frmMainInterface();
         List<string>[] invalids = Project.GetInvalidProjects();
         string invalid_str = "检测到下列无效的项目，是否从数据库记录中移除？\n";
         for (int i = 0; i < invalids[1].Count; i++)
         {
            invalid_str += (i + 1) + ". " + invalids[0][i] + "（数据库文件地址：" + invalids[1][i] + "）\n";
         }
         Action ok_invoke = delegate
         {
            Project.RemoveProjectCollectionFromDb(invalids[1]);
         };
         Action cancel_invoke = delegate
         {
            Thread.Sleep(10);
         };
         if (invalids[1].Count > 0)
         {
            VsSkinMessageBoxOkCancel msg = new VsSkinMessageBoxOkCancel("提示", invalid_str, EMessageLevel.Question, ok_invoke, cancel_invoke);
            msg.Display();     //Project.GetInvalidProjects()方法存在问题，因此这个消息框暂时不允许弹出。
         }
         //RemoveAllInefficientProjects();
         LoadProjects();
         LoadRoles();
         frmWelcome.LoadAndRun(main);
      }
      /// <summary>
      /// 枚举注释获取
      /// </summary>
      /// <param name="_value"></param>
      /// <returns></returns>
      public static string GetEnumDescription(Enum _value)
      {
         if (_value == null)
         {
            throw new ArgumentException("value");
         }
         string description = _value.ToString();
         var fieldInfo = _value.GetType().GetField(description);
         var attributes = (EnumDescriptionAttribute[])fieldInfo.GetCustomAttributes(typeof(EnumDescriptionAttribute), false);
         if (attributes != null && attributes.Length > 0)
         {
            description = attributes[0].Description;
         }
         return description;
      }
      /// <summary>
      /// 加载项目
      /// </summary>
      public static void LoadProjects()
      {
         DatabaseOperation dbopt = new DatabaseOperation(@"Data Source=config\ciwconfig.db");
         List<string> projurls = new List<string>();
         SQLiteDataReader reader;
         dbopt.InitializeConnection();
         dbopt.Connect();
         reader = dbopt.InvokeSqlToReader(@"select * from projects");
         while (reader.Read())
         {
            projurls.Add(reader.GetString(reader.GetOrdinal("_url")));
         }
         reader.Close();
         dbopt.Disconnect();
         for (int i = 0; i < projurls.Count; i++) BuildProject(projurls[i]);
      }
      /// <summary>
      /// 移除无效项目
      /// </summary>
      /// <param name="_dburl">无效的项目的数据库文件地址记录。</param>
      [Obsolete("Not used.")]
      public static void RemoveInefficientProject(string _dburl)
      {
         if (!Project.ProjectDbExists(_dburl)) Project.RemoveProjectFromDb(_dburl);
      }
      /// <summary>
      /// 从配置文件中移除所有无效项目数据库文件的地址记录
      /// </summary>
      [Obsolete("Not used.")]
      public static void RemoveAllInefficientProjects()
      {
         List<string> inefficients = Project.GetInvalidProjects()[1];
         for (int i = 0; i < inefficients.Count; i++) RemoveInefficientProject(inefficients[i]);
      }
      /// <summary>
      /// 生成项目实例
      /// </summary>
      /// <param name="_projurl">项目保存的地址。</param>
      public static void BuildProject(string _projurl)
      {
         Project project = new Project(_projurl, new SNovelInformation());
         project.InitializeProject();
         project.ReadNovelInformation();
         project.ReadUserSetting();
         for (int i = 1; i <= project.GetMaximumNumber("_section", ""); i++)
         {
            project.ReadSection(i);
            for (int j = 1; j <= project.GetMaximumNumber("_chapter", "where _section=" + i); j++)
            {
               project.ReadChapter(i, j);
            }
         }
         Projects.Add(project);
      }
      /// <summary>
      /// 加载所有项目的角色
      /// </summary>
      public static void LoadRoles()
      {
         string dburl = string.Empty;
         for (int i = 0; i < Projects.Count; i++)
         {
            dburl = Projects[i].Database.SourceUri;
            Projects[i].Roles.ReadRolesFromDatabase(dburl);
         }
      }
      public static void UIThreadUnhandledExceptionCatched(object sender, ThreadExceptionEventArgs e)
      {
         Console.WriteLine("\n\n\nUIThreadUnhandledException\n\n" + e.Exception.StackTrace + "\n\n\n");
         VsSkinExceptionForm exform = new VsSkinExceptionForm(e.Exception.Message + "\n\n" + e.Exception.StackTrace);
         exform.ShowDialog();
      }
      public static void CoresThreadUnhandledExceptionCatched(object sender, UnhandledExceptionEventArgs e)
      {
         VsSkinExceptionForm exform = new VsSkinExceptionForm(e.ExceptionObject.ToString() + "\nIsTerminating = " + e.IsTerminating);
         exform.ShowDialog();
      }
   }
}
